<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>BBG Awards ê²°ê³¼ / ì§‘ê³„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    main {
      max-width: 980px;
      margin: 32px auto 80px;
      padding: 0 16px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 8px;
    }
    .sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
    }
    button.primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }
    button:hover {
      opacity: 0.9;
    }
    h2 {
      margin-top: 28px;
      margin-bottom: 6px;
      font-size: 20px;
    }
    .note {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
    }
    .section-body {
      font-size: 14px;
      margin-bottom: 24px;
    }
    .award-block {
      background: #020617;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 10px;
      border: 1px solid #1f2937;
    }
    .award-title-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }
    .award-title {
      font-weight: 600;
      font-size: 15px;
    }
    .award-meta {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
    }
    .winner-line {
      margin-top: 4px;
      font-size: 13px;
      color: #fbbf24;
    }
    ol, ul {
      margin: 6px 0 0;
      padding-left: 18px;
    }
    li {
      margin: 2px 0;
    }
    .muted {
      color: #9ca3af;
      font-size: 13px;
    }
    .error {
      color: #f97373;
      font-size: 13px;
      margin-top: 4px;
    }
    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #111827;
      color: #9ca3af;
      margin-left: 6px;
    }
  </style>
</head>
<body>
<main>
  <h1>BBG Awards ê²°ê³¼ / ì§‘ê³„</h1>
  <div class="sub">
    ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ììš©ì…ë‹ˆë‹¤. Supabase DBì—ì„œ íˆ¬í‘œ ë°ì´í„°ë¥¼ ì½ì–´ì™€<br/>
    ì‚¬ëŒ ì„ íƒí˜•(<code>kind = 'person'</code>) / ì£¼ê´€ì‹(<code>'text'</code>) / ì˜µì…˜í˜•(<code>'option'</code>) ìƒë“¤ì„ ìš”ì•½í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.<br/>
    ì‚¬ëŒ ì„ íƒí˜• ìƒì€ 1ì¸ 1ìƒ ê·œì¹™ì— ë”°ë¼ ì˜ˆìƒ ìˆ˜ìƒìë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
  </div>

  <div class="btn-row">
    <button id="reload-btn">ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="calc-save-btn" class="primary">1ì¸ 1ìƒ ê·œì¹™ìœ¼ë¡œ ìˆ˜ìƒì ê³„ì‚°</button>
    <span id="status-text" class="sub"></span>
  </div>

  <section>
    <h2>1. ì‚¬ëŒ ì„ íƒí˜• ìƒ ê²°ê³¼ (<code>kind = 'person'</code>)</h2>
    <div class="note">ë§ˆê° ì‹œê°„ì´ ì§€ë‚œ ìƒë“¤ì— ëŒ€í•´ 1ì¸ 1ìƒ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆìƒ ìˆ˜ìƒìë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</div>
    <div id="person-section" class="section-body">ë¡œë”© ì¤‘â€¦</div>
  </section>

  <section>
    <h2>2. ì£¼ê´€ì‹ ìƒ ìš”ì•½ (<code>kind = 'text'</code>)</h2>
    <div class="note">ê°™ì€ ë‹µë³€ì€ í•©ì³ì„œ í‘œì‹œí•©ë‹ˆë‹¤. (ëŒ€ì†Œë¬¸ì/ë„ì–´ì“°ê¸° ë‹¨ìˆœ ì •ë¦¬)</div>
    <div id="text-section" class="section-body">ë¡œë”© ì¤‘â€¦</div>
  </section>

  <section>
    <h2>3. ì˜µì…˜í˜• ìƒ ìš”ì•½ (<code>kind = 'option'</code>)</h2>
    <div class="note">ê° ì˜µì…˜ì— ëŒ€í•œ ë“í‘œìˆ˜ë¥¼ ì§‘ê³„í•©ë‹ˆë‹¤.</div>
    <div id="option-section" class="section-body">ë¡œë”© ì¤‘â€¦</div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // âœ… ì—¬ê¸° ë‘ ì¤„ì€ index.htmlê³¼ ì™„ì „íˆ ê°™ì€ ê°’ìœ¼ë¡œ ë°”ê¿” ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
  const supabaseUrl = "https://stjdvynonapqwkhdsdbf.supabase.co";
  const supabaseKey = "sb_publishable_BJOCLYogz4rTiqadKrXpHw_FHtVX--d";

  const supabase = createClient(supabaseUrl, supabaseKey);

  const personSection = document.getElementById("person-section");
  const textSection = document.getElementById("text-section");
  const optionSection = document.getElementById("option-section");
  const reloadBtn = document.getElementById("reload-btn");
  const calcSaveBtn = document.getElementById("calc-save-btn");
  const statusText = document.getElementById("status-text");

  let cached = null; // { awards, users, options, votes }

  function fmtDate(iso) {
    if (!iso) return "ë§ˆê° ì‹œê°„ ë¯¸ì„¤ì •";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "ë§ˆê° ì‹œê°„ í˜•ì‹ ì˜¤ë¥˜";
    const y = d.getFullYear();
    const m = (d.getMonth() + 1).toString().padStart(2, "0");
    const day = d.getDate().toString().padStart(2, "0");
    const hh = d.getHours().toString().padStart(2, "0");
    const mm = d.getMinutes().toString().padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  function groupBy(arr, keyFn) {
    const m = new Map();
    for (const item of arr) {
      const k = keyFn(item);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(item);
    }
    return m;
  }

  async function loadAll() {
    personSection.textContent = "ë¡œë”© ì¤‘â€¦";
    textSection.textContent = "ë¡œë”© ì¤‘â€¦";
    optionSection.textContent = "ë¡œë”© ì¤‘â€¦";
    statusText.textContent = "";

    const [{ data: awards, error: awardsErr },
           { data: users, error: usersErr },
           { data: options, error: optionsErr },
           { data: votes, error: votesErr }] = await Promise.all([
      supabase
        .from("awards")
        .select("id,title,description,end_at,kind,sort_order")
        .order("sort_order", { ascending: true }),
      supabase
        .from("users")
        .select("id,name")
        .order("name", { ascending: true }),
      supabase
        .from("award_options")
        .select("award_id,key,label,image_url"),
      supabase
        .from("votes")
        .select("award_id,voter_id,candidate_id,answer_text,choice_key")
    ]);

    if (awardsErr || usersErr || optionsErr || votesErr) {
      console.error("awardsErr", awardsErr);
      console.error("usersErr", usersErr);
      console.error("optionsErr", optionsErr);
      console.error("votesErr", votesErr);
      const msg =
        (awardsErr && awardsErr.message) ||
        (usersErr && usersErr.message) ||
        (optionsErr && optionsErr.message) ||
        (votesErr && votesErr.message) ||
        "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
      personSection.innerHTML =
        `<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${msg}</div>`;
      textSection.textContent = "";
      optionSection.textContent = "";
      return;
    }

    cached = { awards, users, options, votes };

    const usersById = new Map(users.map(u => [u.id, u]));
    const awardsPerson = awards.filter(a => a.kind === "person");
    const awardsText = awards.filter(a => a.kind === "text");
    const awardsOption = awards.filter(a => a.kind === "option");

    const now = new Date();

    const winners = computePersonWinners(awardsPerson, votes, now);
    renderPersonSection(awardsPerson, votes, usersById, winners, now);
    renderTextSection(awardsText, votes);
    renderOptionSection(awardsOption, votes, options);

    statusText.textContent = `ë§ˆì§€ë§‰ ìƒˆë¡œê³ ì¹¨: ${fmtDate(new Date().toISOString())}`;
  }

  function tallyPersonVotesForAward(awardId, votes) {
    const m = new Map(); // candidate_id -> count
    for (const v of votes) {
      if (v.award_id !== awardId || !v.candidate_id) continue;
      m.set(v.candidate_id, (m.get(v.candidate_id) || 0) + 1);
    }
    const arr = Array.from(m.entries()).map(([candidate_id, count]) => ({ candidate_id, count }));
    arr.sort((a, b) => b.count - a.count);
    return arr;
  }

  function computePersonWinners(awardsPerson, votes, now) {
    const winners = new Map(); // award_id -> { candidate_id, count }
    const usedCandidates = new Set();

    const closedAwards = awardsPerson.filter(a => a.end_at && new Date(a.end_at) <= now);

    for (const award of closedAwards) {
      const tallied = tallyPersonVotesForAward(award.id, votes);
      let chosen = null;
      for (const row of tallied) {
        if (!usedCandidates.has(row.candidate_id)) {
          chosen = row;
          usedCandidates.add(row.candidate_id);
          break;
        }
      }
      if (chosen) {
        winners.set(award.id, chosen);
      }
    }
    return winners;
  }

  function renderPersonSection(awardsPerson, votes, usersById, winners, now) {
    if (!awardsPerson.length) {
      personSection.innerHTML = '<p class="muted">ì‚¬ëŒ ì„ íƒí˜• ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const parts = [];

    for (const award of awardsPerson) {
      const tallied = tallyPersonVotesForAward(award.id, votes);
      const isClosed = award.end_at && new Date(award.end_at) <= now;
      const winnerInfo = winners.get(award.id);

      let html = `<div class="award-block">`;
      html += `<div class="award-title-row">`;
      html += `<div class="award-title">${award.title}</div>`;
      html += `<div class="award-meta">ë§ˆê°: ${fmtDate(award.end_at)}${!isClosed ? ' <span class="pill">ì•„ì§ ë§ˆê° ì „</span>' : ''}</div>`;
      html += `</div>`;
      if (award.description) {
        html += `<div class="muted">${award.description}</div>`;
      }

      if (!tallied.length) {
        html += `<p class="muted">ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
      } else {
        if (winnerInfo && isClosed) {
          const user = usersById.get(winnerInfo.candidate_id);
          const name = user ? user.name : "(ì‚­ì œë¨)";
          html += `<div class="winner-line">ğŸ† ì˜ˆìƒ ìˆ˜ìƒì: <strong>${name}</strong> (${winnerInfo.count}í‘œ)</div>`;
        }
        html += `<ol>`;
        for (const row of tallied) {
          const user = usersById.get(row.candidate_id);
          const name = user ? user.name : "(ì‚­ì œë¨)";
          const crown = winnerInfo && winnerInfo.candidate_id === row.candidate_id ? "ğŸ¥‡ " : "";
          html += `<li>${crown}${name} - ${row.count}í‘œ</li>`;
        }
        html += `</ol>`;
      }

      html += `</div>`;
      parts.push(html);
    }

    personSection.innerHTML = parts.join("");
  }

  function renderTextSection(awardsText, votes) {
    if (!awardsText.length) {
      textSection.innerHTML = '<p class="muted">ì£¼ê´€ì‹ ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const parts = [];

    for (const award of awardsText) {
      const relevant = votes.filter(v => v.award_id === award.id && v.answer_text && v.answer_text.trim().length);
      if (!relevant.length) {
        parts.push(
          `<div class="award-block">
             <div class="award-title-row">
               <div class="award-title">${award.title}</div>
               <div class="award-meta">ì‘ë‹µ 0ê°œ</div>
             </div>
             <p class="muted">ì•„ì§ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
           </div>`
        );
        continue;
      }

      const counts = groupBy(relevant, v => v.answer_text.trim());
      const rows = Array.from(counts.entries()).map(([answer, arr]) => ({
        answer,
        count: arr.length
      }));
      rows.sort((a, b) => b.count - a.count);

      let html = `<div class="award-block">`;
      html += `<div class="award-title-row">
                 <div class="award-title">${award.title}</div>
                 <div class="award-meta">ì‘ë‹µ ${relevant.length}ê°œ</div>
               </div>`;
      if (award.description) {
        html += `<div class="muted">${award.description}</div>`;
      }
      html += `<ol>`;
      for (const row of rows) {
        html += `<li>${row.answer} - ${row.count}í‘œ</li>`;
      }
      html += `</ol>`;
      html += `</div>`;
      parts.push(html);
    }

    textSection.innerHTML = parts.join("");
  }

  function renderOptionSection(awardsOption, votes, options) {
    if (!awardsOption.length) {
      optionSection.innerHTML = '<p class="muted">ì˜µì…˜í˜• ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const labelMap = new Map(); // `${award_id}|${key}` -> label
    for (const o of options) {
      labelMap.set(`${o.award_id}|${o.key}`, o.label || o.key);
    }

    const parts = [];

    for (const award of awardsOption) {
      const relevant = votes.filter(v => v.award_id === award.id && v.choice_key);
      if (!relevant.length) {
        parts.push(
          `<div class="award-block">
             <div class="award-title-row">
               <div class="award-title">${award.title}</div>
               <div class="award-meta">íˆ¬í‘œ 0ê°œ</div>
             </div>
             <p class="muted">ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
           </div>`
        );
        continue;
      }

      const counts = groupBy(relevant, v => v.choice_key);
      const rows = Array.from(counts.entries()).map(([key, arr]) => ({
        key,
        label: labelMap.get(`${award.id}|${key}`) || key,
        count: arr.length
      }));
      rows.sort((a, b) => b.count - a.count);

      let html = `<div class="award-block">`;
      html += `<div class="award-title-row">
                 <div class="award-title">${award.title}</div>
                 <div class="award-meta">íˆ¬í‘œ ${relevant.length}ê°œ</div>
               </div>`;
      if (award.description) {
        html += `<div class="muted">${award.description}</div>`;
      }
      html += `<ol>`;
      for (const row of rows) {
        html += `<li>${row.label} - ${row.count}í‘œ</li>`;
      }
      html += `</ol>`;
      html += `</div>`;
      parts.push(html);
    }

    optionSection.innerHTML = parts.join("");
  }

  // 1ì¸ 1ìƒ ê·œì¹™ìœ¼ë¡œ ì˜ˆìƒ ìˆ˜ìƒì ê³„ì‚°ë§Œ ë‹¤ì‹œ ìˆ˜í–‰ (DB ì €ì¥ì€ í•˜ì§€ ì•ŠìŒ)
  async function recalcWinnersOnly() {
    if (!cached) {
      await loadAll();
      return;
    }
    const { awards, votes, users } = cached;
    const usersById = new Map(users.map(u => [u.id, u]));
    const awardsPerson = awards.filter(a => a.kind === "person");
    const now = new Date();
    const winners = computePersonWinners(awardsPerson, votes, now);
    renderPersonSection(awardsPerson, votes, usersById, winners, now);
    statusText.textContent = "1ì¸ 1ìƒ ê·œì¹™ìœ¼ë¡œ ì˜ˆìƒ ìˆ˜ìƒìë¥¼ ë‹¤ì‹œ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.";
  }

  reloadBtn.addEventListener("click", loadAll);
  calcSaveBtn.addEventListener("click", recalcWinnersOnly);

  // ìµœì´ˆ ë¡œë”©
  loadAll();
</script>
</body>
</html>
