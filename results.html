<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>BBG Awards ê²°ê³¼ / ì§‘ê³„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      margin: 16px 0 8px;
      text-align: center;
    }
    h2 {
      font-size: 18px;
      margin: 16px 0 8px;
    }
    p { font-size: 13px; color:#9ca3af; }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      margin-right: 8px;
    }
    button.secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1e293b;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .error { color: #fecaca; font-size: 13px; margin-top: 6px; }
    .notice { color: #a5b4fc; font-size: 13px; margin-top: 6px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 24px;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td { background: #020617; }
    tr:nth-child(odd) td { background: #020617; }
    .badge {
      display: inline-block;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }
    .small { font-size: 12px; color:#9ca3af; }
    .meme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    .meme-card {
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: #020617;
      padding: 6px;
      font-size: 12px;
    }
    .meme-card img {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
      max-height: 160px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>BBG Awards ê²°ê³¼ / ì§‘ê³„</h1>
    <p>
      ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ììš©ì…ë‹ˆë‹¤. Supabase DBì˜ ë‚´ìš©ì„ ì½ì–´ì„œ í˜„ì¬ íˆ¬í‘œ ìƒí™©ì„ ìš”ì•½í•˜ê³ ,  
      <b>ì‚¬ëŒ ì„ íƒí˜•(kind = 'person') ìƒë“¤</b>ì— ëŒ€í•´ <b>1ì¸ 1ìƒ ê·œì¹™</b>ìœ¼ë¡œ ìë™ ìˆ˜ìƒìë¥¼ ê³„ì‚°í•´ <code>winner_id</code>ì— ë°˜ì˜í•©ë‹ˆë‹¤.
    </p>

    <div>
      <button id="reload-btn" class="secondary">ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="calc-btn">1ì¸ 1ìƒ ê·œì¹™ìœ¼ë¡œ ìˆ˜ìƒì ê³„ì‚° / ì €ì¥</button>
      <span id="status" class="notice"></span>
    </div>

    <h2>1. ì‚¬ëŒ ì„ íƒí˜• ìƒ ê²°ê³¼ (kind = 'person')</h2>
    <p>ë§ˆê° ì‹œê°„ì´ ì§€ë‚œ ìƒë“¤ë§Œ 1ì¸ 1ìƒ ê³„ì‚° ëŒ€ìƒì´ ë©ë‹ˆë‹¤. (end_at â‰¤ í˜„ì¬ ì‹œê°)</p>
    <div id="person-table-wrap">ë¡œë”© ì¤‘...</div>

    <h2>2. ì£¼ê´€ì‹ ìƒ ìš”ì•½ (kind = 'text')</h2>
    <div id="text-awards-wrap" class="small">ë¡œë”© ì¤‘...</div>

    <h2>3. ì˜µì…˜í˜• ìƒ ìš”ì•½ (kind = 'option')</h2>
    <div id="option-awards-wrap" class="small">ë¡œë”© ì¤‘...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ğŸ”§ ì—¬ê¸°ë„ ë„¤ Supabase í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ ë™ì¼í•˜ê²Œ ì„¤ì •
    const SUPABASE_URL = "https://stjdvynonapqwkhdsdbf.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_BJOCLYogz4rTiqadKrXpHw_FHtVX--d";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const reloadBtn = document.getElementById("reload-btn");
    const calcBtn = document.getElementById("calc-btn");
    const statusEl = document.getElementById("status");
    const personWrap = document.getElementById("person-table-wrap");
    const textWrap = document.getElementById("text-awards-wrap");
    const optionWrap = document.getElementById("option-awards-wrap");

    let awards = [];
    let users = [];
    let votes = [];
    let options = [];
    let usersById = {};
    let awardsById = {};
    let optionsByAward = {};

    function formatDateTime(value) {
      if (!value) return "";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    async function loadAll() {
      statusEl.textContent = "";
      personWrap.textContent = "ë¡œë”© ì¤‘...";
      textWrap.textContent = "ë¡œë”© ì¤‘...";
      optionWrap.textContent = "ë¡œë”© ì¤‘...";

      const [
        { data: awardsData, error: aErr },
        { data: usersData, error: uErr },
        { data: votesData, error: vErr },
        { data: optionsData, error: oErr },
      ] = await Promise.all([
        supabaseClient
          .from("awards")
          .select("id,title,description,end_at,kind,created_at,winner_id")
          .order("created_at", { ascending: true }),
        supabaseClient
          .from("users")
          .select("id,name,login_id")
          .order("name", { ascending: true }),
        supabaseClient
          .from("votes")
          .select("award_id,voter_id,candidate_id,answer_text,choice_key"),
        supabaseClient
          .from("award_options")
          .select("award_id,key,label,image_url"),
      ]);

      if (aErr || uErr || vErr || oErr) {
        console.error(aErr || uErr || vErr || oErr);
        statusEl.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      awards = awardsData || [];
      users = usersData || [];
      votes = votesData || [];
      options = optionsData || [];

      usersById = {};
      users.forEach(u => { usersById[u.id] = u; });

      awardsById = {};
      awards.forEach(a => { awardsById[a.id] = a; });

      optionsByAward = {};
      options.forEach(o => {
        if (!optionsByAward[o.award_id]) optionsByAward[o.award_id] = [];
        optionsByAward[o.award_id].push(o);
      });

      renderPersonAwards();
      renderTextAwards();
      renderOptionAwards();
    }

    function renderPersonAwards() {
      const personAwards = awards.filter(a => (a.kind || "person") === "person");
      if (personAwards.length === 0) {
        personWrap.textContent = "ì‚¬ëŒ ì„ íƒí˜• ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      // award_id -> candidate_id -> count
      const countsByAward = {};
      votes.forEach(v => {
        if (!v.candidate_id) return;
        if (!countsByAward[v.award_id]) countsByAward[v.award_id] = {};
        const m = countsByAward[v.award_id];
        m[v.candidate_id] = (m[v.candidate_id] || 0) + 1;
      });

      const now = new Date();

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th style="width:26px;">#</th>
          <th style="width:220px;">ìƒ ì´ë¦„</th>
          <th style="width:120px;">ë§ˆê° / ìƒíƒœ</th>
          <th style="width:160px;">í˜„ì¬ winner_id</th>
          <th>ë“í‘œ í˜„í™© (1ìœ„ë¶€í„°)</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      personAwards.forEach((a, idx) => {
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = idx + 1;
        tr.appendChild(tdIdx);

        const tdTitle = document.createElement("td");
        tdTitle.innerHTML = `<b>${a.title}</b><br/><span class="small">${a.description || ""}</span>`;
        tr.appendChild(tdTitle);

        const tdEnd = document.createElement("td");
        const isClosed = a.end_at && new Date(a.end_at) <= now;
        tdEnd.innerHTML =
          (a.end_at ? formatDateTime(a.end_at) : "ë§ˆê° ë¯¸ì„¤ì •") +
          `<br/><span class="badge">${isClosed ? "ë§ˆê°ë¨" : "ì§„í–‰ ì¤‘"}</span>`;
        tr.appendChild(tdEnd);

        const tdWinner = document.createElement("td");
        if (a.winner_id) {
          const u = usersById[a.winner_id];
          tdWinner.innerHTML = `<b>${u ? u.name : "(ì‚­ì œëœ ì‚¬ìš©ì?)"}</b><br/><span class="small">${a.winner_id}</span>`;
        } else {
          tdWinner.innerHTML = `<span class="small">winner_id ë¯¸ì„¤ì •</span>`;
        }
        tr.appendChild(tdWinner);

        const tdStats = document.createElement("td");
        const counts = countsByAward[a.id] || {};
        const entries = Object.entries(counts).map(([cid, cnt]) => ({
          candidate_id: cid,
          count: cnt
        }));
        entries.sort((x, y) => y.count - x.count);

        if (entries.length === 0) {
          tdStats.innerHTML = `<span class="small">ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        } else {
          tdStats.innerHTML = entries.map((e, rank) => {
            const u = usersById[e.candidate_id];
            const name = u ? u.name : "(ì‚­ì œë¨)";
            const highlight = (a.winner_id && a.winner_id === e.candidate_id)
              ? `<b>${rank + 1}ìœ„ ${name} â€“ ${e.count}í‘œ (winner)</b>`
              : `${rank + 1}ìœ„ ${name} â€“ ${e.count}í‘œ`;
            return highlight;
          }).join("<br/>");
        }

        tr.appendChild(tdStats);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      personWrap.innerHTML = "";
      personWrap.appendChild(table);
    }

    function renderTextAwards() {
      const textAwards = awards.filter(a => a.kind === "text");
      if (textAwards.length === 0) {
        textWrap.textContent = "ì£¼ê´€ì‹ ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      const container = document.createElement("div");

      textAwards.forEach(a => {
        const title = document.createElement("div");
        title.innerHTML = `<b>${a.title}</b> <span class="badge">text</span>`;
        container.appendChild(title);

        if (a.description) {
          const desc = document.createElement("div");
          desc.className = "small";
          desc.textContent = a.description;
          container.appendChild(desc);
        }

        const list = document.createElement("ul");
        list.style.marginTop = "4px";

        const related = votes.filter(v => v.award_id === a.id && v.answer_text);
        if (related.length === 0) {
          const li = document.createElement("li");
          li.className = "small";
          li.textContent = "ì‘ë‹µ ì—†ìŒ";
          list.appendChild(li);
        } else {
          related.forEach(v => {
            const u = usersById[v.voter_id];
            const li = document.createElement("li");
            li.className = "small";
            li.textContent = `${u ? u.name : "(ì•Œ ìˆ˜ ì—†ìŒ)"}: ${v.answer_text}`;
            list.appendChild(li);
          });
        }

        container.appendChild(list);
        container.appendChild(document.createElement("hr"));
      });

      textWrap.innerHTML = "";
      textWrap.appendChild(container);
    }

    function renderOptionAwards() {
      const optionAwards = awards.filter(a => a.kind === "option");
      if (optionAwards.length === 0) {
        optionWrap.textContent = "ì˜µì…˜í˜• ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const container = document.createElement("div");
      optionAwards.forEach(a => {
        const opts = optionsByAward[a.id] || [];

        const title = document.createElement("div");
        title.innerHTML = `<b>${a.title}</b> <span class="badge">option</span>`;
        container.appendChild(title);

        if (a.description) {
          const desc = document.createElement("div");
          desc.className = "small";
          desc.textContent = a.description;
          container.appendChild(desc);
        }

        // choice_key -> count
        const countByChoice = {};
        votes.filter(v => v.award_id === a.id && v.choice_key).forEach(v => {
          countByChoice[v.choice_key] = (countByChoice[v.choice_key] || 0) + 1;
        });

        const hasImage = opts.some(o => o.image_url);

        if (hasImage) {
          // ì§¤ë°© ê°™ì€ ê²½ìš°: ì´ë¯¸ì§€ + í‘œ ìˆ˜
          const grid = document.createElement("div");
          grid.className = "meme-grid";

          opts.forEach(o => {
            const card = document.createElement("div");
            card.className = "meme-card";

            if (o.image_url) {
              const img = document.createElement("img");
              img.src = o.image_url;
              img.alt = o.label;
              card.appendChild(img);
            }

            const label = document.createElement("div");
            label.textContent = o.label;
            card.appendChild(label);

            const cnt = countByChoice[o.key] || 0;
            const cntEl = document.createElement("div");
            cntEl.className = "small";
            cntEl.textContent = `${cnt} í‘œ`;
            card.appendChild(cntEl);

            grid.appendChild(card);
          });

          container.appendChild(grid);
        } else {
          // ì§€ë‹ˆì–´ìŠ¤ ì²˜ëŸ¼ í…ìŠ¤íŠ¸ ì˜µì…˜ë§Œ
          const list = document.createElement("ul");
          list.style.marginTop = "4px";

          opts.forEach(o => {
            const li = document.createElement("li");
            const cnt = countByChoice[o.key] || 0;
            li.className = "small";
            li.textContent = `${o.label} â€“ ${cnt}í‘œ`;
            list.appendChild(li);
          });

          container.appendChild(list);
        }

        container.appendChild(document.createElement("hr"));
      });

      optionWrap.innerHTML = "";
      optionWrap.appendChild(container);
    }

    async function calculateWinnersOnePerPerson() {
      statusEl.textContent = "";
      calcBtn.disabled = true;

      const personAwards = awards.filter(a => (a.kind || "person") === "person");
      if (personAwards.length === 0) {
        statusEl.textContent = "ì‚¬ëŒ ì„ íƒí˜• ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
        calcBtn.disabled = false;
        return;
      }

      const now = new Date();
      const endedAwards = personAwards.filter(a => a.end_at && new Date(a.end_at) <= now);
      if (endedAwards.length === 0) {
        statusEl.textContent = "ë§ˆê°(end_at)ì´ ì§€ë‚œ ì‚¬ëŒ ì„ íƒí˜• ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
        calcBtn.disabled = false;
        return;
      }

      // award_id -> candidate_id -> count
      const countsByAward = {};
      votes.forEach(v => {
        if (!v.candidate_id) return;
        if (!countsByAward[v.award_id]) countsByAward[v.award_id] = {};
        const m = countsByAward[v.award_id];
        m[v.candidate_id] = (m[v.candidate_id] || 0) + 1;
      });

      // created_at ìˆœìœ¼ë¡œ ì •ë ¬ í›„ 1ì¸ 1ìƒ ê³„ì‚°
      const sortedAwards = endedAwards.slice().sort((a, b) => {
        return new Date(a.created_at) - new Date(b.created_at);
      });

      const usedWinners = new Set();
      const winnersByAward = {};

      // ì´ë¯¸ winner_idê°€ ë“¤ì–´ìˆëŠ” ìƒì€ ë¨¼ì € ì‚¬ìš© ì²˜ë¦¬
      sortedAwards.forEach(a => {
        if (a.winner_id) {
          usedWinners.add(a.winner_id);
          winnersByAward[a.id] = a.winner_id;
        }
      });

      sortedAwards.forEach(a => {
        if (a.winner_id) return; // ì´ë¯¸ ìˆ˜ë™ ì„¤ì •ëœ ê²ƒì€ ê±´ë„ˆë›´ë‹¤

        const counts = countsByAward[a.id] || {};
        const entries = Object.entries(counts).map(([cid, cnt]) => ({
          candidate_id: cid,
          count: cnt
        }));
        entries.sort((x, y) => y.count - x.count);

        let chosen = null;
        for (const e of entries) {
          if (!usedWinners.has(e.candidate_id)) {
            chosen = e.candidate_id;
            break;
          }
        }
        // ëª¨ë‘ ì´ë¯¸ ìƒì„ ë°›ì•˜ë‹¤ë©´ chosenì€ null(ìˆ˜ìƒì ì—†ìŒ)
        if (chosen) {
          winnersByAward[a.id] = chosen;
          usedWinners.add(chosen);
        } else {
          winnersByAward[a.id] = null;
        }
      });

      // DBì— ë°˜ì˜
      try {
        const updates = [];
        for (const a of sortedAwards) {
          if (!Object.prototype.hasOwnProperty.call(winnersByAward, a.id)) continue;
          const wid = winnersByAward[a.id];
          updates.push({ id: a.id, winner_id: wid });
        }

        for (const u of updates) {
          const { error } = await supabaseClient
            .from("awards")
            .update({ winner_id: u.winner_id })
            .eq("id", u.id);
          if (error) throw error;
        }

        statusEl.textContent = "1ì¸ 1ìƒ ê·œì¹™ìœ¼ë¡œ winner_id ì €ì¥ ì™„ë£Œ. (í™”ë©´ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë°˜ì˜ë¨)";
        await loadAll();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "winner ê³„ì‚°/ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      } finally {
        calcBtn.disabled = false;
      }
    }

    reloadBtn.addEventListener("click", loadAll);
    calcBtn.addEventListener("click", calculateWinnersOnePerPerson);

    loadAll();
  </script>
</body>
</html>
